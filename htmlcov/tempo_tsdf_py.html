<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=emulateIE7" />
    <title>Coverage for tempo/tsdf.py: 17%</title>
    <link rel="stylesheet" href="style.css" type="text/css">
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jquery.hotkeys.js"></script>
    <script type="text/javascript" src="jquery.isonscreen.js"></script>
    <script type="text/javascript" src="coverage_html.js"></script>
    <script type="text/javascript">
        jQuery(document).ready(coverage.pyfile_ready);
    </script>
</head>
<body class="pyfile">
<div id="header">
    <div class="content">
        <h1>Coverage for <b>tempo/tsdf.py</b> :
            <span class="pc_cov">17%</span>
        </h1>
        <img id="keyboard_icon" src="keybd_closed.png" alt="Show keyboard shortcuts" />
        <h2 class="stats">
            150 statements &nbsp;
            <button type="button" class="run shortkey_r button_toggle_run" title="Toggle lines run">25 run</button>
            <button type="button" class="mis show_mis shortkey_m button_toggle_mis" title="Toggle lines missing">125 missing</button>
            <button type="button" class="exc show_exc shortkey_x button_toggle_exc" title="Toggle lines excluded">0 excluded</button>
        </h2>
    </div>
</div>
<div class="help_panel">
    <img id="panel_icon" src="keybd_open.png" alt="Hide keyboard shortcuts" />
    <p class="legend">Hot-keys on this page</p>
    <div>
    <p class="keyhelp">
        <span class="key">r</span>
        <span class="key">m</span>
        <span class="key">x</span>
        <span class="key">p</span> &nbsp; toggle line displays
    </p>
    <p class="keyhelp">
        <span class="key">j</span>
        <span class="key">k</span> &nbsp; next/prev highlighted chunk
    </p>
    <p class="keyhelp">
        <span class="key">0</span> &nbsp; (zero) top of page
    </p>
    <p class="keyhelp">
        <span class="key">1</span> &nbsp; (one) first highlighted chunk
    </p>
    </div>
</div>
<div id="source">
    <p id="t1" class="run"><span class="n"><a href="#t1">1</a></span><span class="t"><span class="key">import</span> <span class="nam">pyspark</span><span class="op">.</span><span class="nam">sql</span><span class="op">.</span><span class="nam">functions</span> <span class="key">as</span> <span class="nam">f</span>&nbsp;</span><span class="r"></span></p>
    <p id="t2" class="run"><span class="n"><a href="#t2">2</a></span><span class="t"><span class="key">from</span> <span class="nam">pyspark</span><span class="op">.</span><span class="nam">sql</span><span class="op">.</span><span class="nam">window</span> <span class="key">import</span> <span class="nam">Window</span>&nbsp;</span><span class="r"></span></p>
    <p id="t3" class="run"><span class="n"><a href="#t3">3</a></span><span class="t"><span class="key">import</span> <span class="nam">tempo</span><span class="op">.</span><span class="nam">resample</span> <span class="key">as</span> <span class="nam">rs</span>&nbsp;</span><span class="r"></span></p>
    <p id="t4" class="run"><span class="n"><a href="#t4">4</a></span><span class="t"><span class="key">import</span> <span class="nam">tempo</span><span class="op">.</span><span class="nam">io</span> <span class="key">as</span> <span class="nam">tio</span>&nbsp;</span><span class="r"></span></p>
    <p id="t5" class="pln"><span class="n"><a href="#t5">5</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t6" class="run"><span class="n"><a href="#t6">6</a></span><span class="t"><span class="key">class</span> <span class="nam">TSDF</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t7" class="pln"><span class="n"><a href="#t7">7</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t8" class="run"><span class="n"><a href="#t8">8</a></span><span class="t">  <span class="key">def</span> <span class="nam">__init__</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">df</span><span class="op">,</span> <span class="nam">ts_col</span><span class="op">=</span><span class="str">"event_ts"</span><span class="op">,</span> <span class="nam">partition_cols</span><span class="op">=</span><span class="key">None</span><span class="op">,</span> <span class="nam">sequence_col</span> <span class="op">=</span> <span class="key">None</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t9" class="pln"><span class="n"><a href="#t9">9</a></span><span class="t">    <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t10" class="pln"><span class="n"><a href="#t10">10</a></span><span class="t"><span class="str">    Constructor</span>&nbsp;</span><span class="r"></span></p>
    <p id="t11" class="pln"><span class="n"><a href="#t11">11</a></span><span class="t"><span class="str">    :param df:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t12" class="pln"><span class="n"><a href="#t12">12</a></span><span class="t"><span class="str">    :param ts_col:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t13" class="pln"><span class="n"><a href="#t13">13</a></span><span class="t"><span class="str">    :param partitionCols:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t14" class="pln"><span class="n"><a href="#t14">14</a></span><span class="t"><span class="str">    :sequence_col every tsdf allows for a tie-breaker secondary sort key</span>&nbsp;</span><span class="r"></span></p>
    <p id="t15" class="pln"><span class="n"><a href="#t15">15</a></span><span class="t"><span class="str">    """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t16" class="mis show_mis"><span class="n"><a href="#t16">16</a></span><span class="t">    <span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">__validated_column</span><span class="op">(</span><span class="nam">df</span><span class="op">,</span> <span class="nam">ts_col</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t17" class="mis show_mis"><span class="n"><a href="#t17">17</a></span><span class="t">    <span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span> <span class="key">if</span> <span class="nam">partition_cols</span> <span class="key">is</span> <span class="key">None</span> <span class="key">else</span> <span class="nam">self</span><span class="op">.</span><span class="nam">__validated_columns</span><span class="op">(</span><span class="nam">df</span><span class="op">,</span> <span class="nam">partition_cols</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t18" class="pln"><span class="n"><a href="#t18">18</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t19" class="mis show_mis"><span class="n"><a href="#t19">19</a></span><span class="t">    <span class="nam">self</span><span class="op">.</span><span class="nam">df</span> <span class="op">=</span> <span class="nam">df</span>&nbsp;</span><span class="r"></span></p>
    <p id="t20" class="mis show_mis"><span class="n"><a href="#t20">20</a></span><span class="t">    <span class="nam">self</span><span class="op">.</span><span class="nam">sequence_col</span> <span class="op">=</span> <span class="str">''</span> <span class="key">if</span> <span class="nam">sequence_col</span> <span class="key">is</span> <span class="key">None</span> <span class="key">else</span> <span class="nam">sequence_col</span>&nbsp;</span><span class="r"></span></p>
    <p id="t21" class="mis show_mis"><span class="n"><a href="#t21">21</a></span><span class="t">    <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t22" class="pln"><span class="n"><a href="#t22">22</a></span><span class="t"><span class="str">    Make sure DF is ordered by its respective ts_col and partition columns.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t23" class="pln"><span class="n"><a href="#t23">23</a></span><span class="t"><span class="str">    """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t24" class="pln"><span class="n"><a href="#t24">24</a></span><span class="t">  <span class="com">##</span>&nbsp;</span><span class="r"></span></p>
    <p id="t25" class="pln"><span class="n"><a href="#t25">25</a></span><span class="t">  <span class="com">## Helper functions</span>&nbsp;</span><span class="r"></span></p>
    <p id="t26" class="pln"><span class="n"><a href="#t26">26</a></span><span class="t">  <span class="com">##</span>&nbsp;</span><span class="r"></span></p>
    <p id="t27" class="pln"><span class="n"><a href="#t27">27</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t28" class="run"><span class="n"><a href="#t28">28</a></span><span class="t">  <span class="key">def</span> <span class="nam">__validated_column</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span><span class="nam">df</span><span class="op">,</span><span class="nam">colname</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t29" class="mis show_mis"><span class="n"><a href="#t29">29</a></span><span class="t">    <span class="key">if</span> <span class="nam">type</span><span class="op">(</span><span class="nam">colname</span><span class="op">)</span> <span class="op">!=</span> <span class="nam">str</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t30" class="mis show_mis"><span class="n"><a href="#t30">30</a></span><span class="t">      <span class="key">raise</span> <span class="nam">TypeError</span><span class="op">(</span><span class="str">f"Column names must be of type str; found {type(colname)} instead!"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t31" class="mis show_mis"><span class="n"><a href="#t31">31</a></span><span class="t">    <span class="key">if</span> <span class="nam">colname</span><span class="op">.</span><span class="nam">lower</span><span class="op">(</span><span class="op">)</span> <span class="key">not</span> <span class="key">in</span> <span class="op">[</span><span class="nam">col</span><span class="op">.</span><span class="nam">lower</span><span class="op">(</span><span class="op">)</span> <span class="key">for</span> <span class="nam">col</span> <span class="key">in</span> <span class="nam">df</span><span class="op">.</span><span class="nam">columns</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t32" class="mis show_mis"><span class="n"><a href="#t32">32</a></span><span class="t">      <span class="key">raise</span> <span class="nam">ValueError</span><span class="op">(</span><span class="str">f"Column {colname} not found in Dataframe"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t33" class="mis show_mis"><span class="n"><a href="#t33">33</a></span><span class="t">    <span class="key">return</span> <span class="nam">colname</span>&nbsp;</span><span class="r"></span></p>
    <p id="t34" class="pln"><span class="n"><a href="#t34">34</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t35" class="run"><span class="n"><a href="#t35">35</a></span><span class="t">  <span class="key">def</span> <span class="nam">__validated_columns</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span><span class="nam">df</span><span class="op">,</span><span class="nam">colnames</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t36" class="pln"><span class="n"><a href="#t36">36</a></span><span class="t">    <span class="com"># if provided a string, treat it as a single column</span>&nbsp;</span><span class="r"></span></p>
    <p id="t37" class="mis show_mis"><span class="n"><a href="#t37">37</a></span><span class="t">    <span class="key">if</span> <span class="nam">type</span><span class="op">(</span><span class="nam">colnames</span><span class="op">)</span> <span class="op">==</span> <span class="nam">str</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t38" class="mis show_mis"><span class="n"><a href="#t38">38</a></span><span class="t">      <span class="nam">colnames</span> <span class="op">=</span> <span class="op">[</span> <span class="nam">colnames</span> <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t39" class="pln"><span class="n"><a href="#t39">39</a></span><span class="t">    <span class="com"># otherwise we really should have a list or None</span>&nbsp;</span><span class="r"></span></p>
    <p id="t40" class="mis show_mis"><span class="n"><a href="#t40">40</a></span><span class="t">    <span class="key">if</span> <span class="nam">colnames</span> <span class="key">is</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t41" class="mis show_mis"><span class="n"><a href="#t41">41</a></span><span class="t">      <span class="nam">colnames</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t42" class="mis show_mis"><span class="n"><a href="#t42">42</a></span><span class="t">    <span class="key">elif</span> <span class="nam">type</span><span class="op">(</span><span class="nam">colnames</span><span class="op">)</span> <span class="op">!=</span> <span class="nam">list</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t43" class="mis show_mis"><span class="n"><a href="#t43">43</a></span><span class="t">      <span class="key">raise</span> <span class="nam">TypeError</span><span class="op">(</span><span class="str">f"Columns must be of type list, str, or None; found {type(colnames)} instead!"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t44" class="pln"><span class="n"><a href="#t44">44</a></span><span class="t">    <span class="com"># validate each column</span>&nbsp;</span><span class="r"></span></p>
    <p id="t45" class="mis show_mis"><span class="n"><a href="#t45">45</a></span><span class="t">    <span class="key">for</span> <span class="nam">col</span> <span class="key">in</span> <span class="nam">colnames</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t46" class="mis show_mis"><span class="n"><a href="#t46">46</a></span><span class="t">      <span class="nam">self</span><span class="op">.</span><span class="nam">__validated_column</span><span class="op">(</span><span class="nam">df</span><span class="op">,</span><span class="nam">col</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t47" class="mis show_mis"><span class="n"><a href="#t47">47</a></span><span class="t">    <span class="key">return</span> <span class="nam">colnames</span>&nbsp;</span><span class="r"></span></p>
    <p id="t48" class="pln"><span class="n"><a href="#t48">48</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t49" class="run"><span class="n"><a href="#t49">49</a></span><span class="t">  <span class="key">def</span> <span class="nam">__checkPartitionCols</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span><span class="nam">tsdf_right</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t50" class="mis show_mis"><span class="n"><a href="#t50">50</a></span><span class="t">    <span class="key">for</span> <span class="nam">left_col</span><span class="op">,</span> <span class="nam">right_col</span> <span class="key">in</span> <span class="nam">zip</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">,</span> <span class="nam">tsdf_right</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t51" class="mis show_mis"><span class="n"><a href="#t51">51</a></span><span class="t">        <span class="key">if</span> <span class="nam">left_col</span> <span class="op">!=</span> <span class="nam">right_col</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t52" class="mis show_mis"><span class="n"><a href="#t52">52</a></span><span class="t">            <span class="key">raise</span> <span class="nam">ValueError</span><span class="op">(</span><span class="str">"left and right dataframe partition columns should have same name in same order"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t53" class="pln"><span class="n"><a href="#t53">53</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t54" class="run"><span class="n"><a href="#t54">54</a></span><span class="t">  <span class="key">def</span> <span class="nam">__addPrefixToColumns</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span><span class="nam">col_list</span><span class="op">,</span><span class="nam">prefix</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t55" class="pln"><span class="n"><a href="#t55">55</a></span><span class="t">    <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t56" class="pln"><span class="n"><a href="#t56">56</a></span><span class="t"><span class="str">    Add prefix to all specified columns.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t57" class="pln"><span class="n"><a href="#t57">57</a></span><span class="t"><span class="str">    """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t58" class="mis show_mis"><span class="n"><a href="#t58">58</a></span><span class="t">    <span class="key">from</span> <span class="nam">functools</span> <span class="key">import</span> <span class="nam">reduce</span>&nbsp;</span><span class="r"></span></p>
    <p id="t59" class="pln"><span class="n"><a href="#t59">59</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t60" class="mis show_mis"><span class="n"><a href="#t60">60</a></span><span class="t">    <span class="nam">df</span> <span class="op">=</span> <span class="nam">reduce</span><span class="op">(</span><span class="key">lambda</span> <span class="nam">df</span><span class="op">,</span> <span class="nam">idx</span><span class="op">:</span> <span class="nam">df</span><span class="op">.</span><span class="nam">withColumnRenamed</span><span class="op">(</span><span class="nam">col_list</span><span class="op">[</span><span class="nam">idx</span><span class="op">]</span><span class="op">,</span> <span class="str">'_'</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="op">[</span><span class="nam">prefix</span><span class="op">,</span><span class="nam">col_list</span><span class="op">[</span><span class="nam">idx</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t61" class="pln"><span class="n"><a href="#t61">61</a></span><span class="t">                <span class="nam">range</span><span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">col_list</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">df</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t62" class="pln"><span class="n"><a href="#t62">62</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t63" class="mis show_mis"><span class="n"><a href="#t63">63</a></span><span class="t">    <span class="nam">ts_col</span> <span class="op">=</span> <span class="str">'_'</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="op">[</span><span class="nam">prefix</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t64" class="mis show_mis"><span class="n"><a href="#t64">64</a></span><span class="t">    <span class="nam">seq_col</span> <span class="op">=</span> <span class="str">'_'</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="op">[</span><span class="nam">prefix</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">sequence_col</span><span class="op">]</span><span class="op">)</span> <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">sequence_col</span> <span class="key">else</span> <span class="nam">self</span><span class="op">.</span><span class="nam">sequence_col</span>&nbsp;</span><span class="r"></span></p>
    <p id="t65" class="mis show_mis"><span class="n"><a href="#t65">65</a></span><span class="t">    <span class="key">return</span> <span class="nam">TSDF</span><span class="op">(</span><span class="nam">df</span><span class="op">,</span> <span class="nam">ts_col</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">,</span> <span class="nam">sequence_col</span> <span class="op">=</span> <span class="nam">seq_col</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t66" class="pln"><span class="n"><a href="#t66">66</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t67" class="run"><span class="n"><a href="#t67">67</a></span><span class="t">  <span class="key">def</span> <span class="nam">__addColumnsFromOtherDF</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">other_cols</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t68" class="pln"><span class="n"><a href="#t68">68</a></span><span class="t">    <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t69" class="pln"><span class="n"><a href="#t69">69</a></span><span class="t"><span class="str">    Add columns from some other DF as lit(None), as pre-step before union.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t70" class="pln"><span class="n"><a href="#t70">70</a></span><span class="t"><span class="str">    """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t71" class="mis show_mis"><span class="n"><a href="#t71">71</a></span><span class="t">    <span class="key">from</span> <span class="nam">functools</span> <span class="key">import</span> <span class="nam">reduce</span>&nbsp;</span><span class="r"></span></p>
    <p id="t72" class="mis show_mis"><span class="n"><a href="#t72">72</a></span><span class="t">    <span class="nam">new_df</span> <span class="op">=</span> <span class="nam">reduce</span><span class="op">(</span><span class="key">lambda</span> <span class="nam">df</span><span class="op">,</span> <span class="nam">idx</span><span class="op">:</span> <span class="nam">df</span><span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="nam">other_cols</span><span class="op">[</span><span class="nam">idx</span><span class="op">]</span><span class="op">,</span> <span class="nam">f</span><span class="op">.</span><span class="nam">lit</span><span class="op">(</span><span class="key">None</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="nam">range</span><span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">other_cols</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">df</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t73" class="pln"><span class="n"><a href="#t73">73</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t74" class="mis show_mis"><span class="n"><a href="#t74">74</a></span><span class="t">    <span class="key">return</span> <span class="nam">TSDF</span><span class="op">(</span><span class="nam">new_df</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t75" class="pln"><span class="n"><a href="#t75">75</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t76" class="run"><span class="n"><a href="#t76">76</a></span><span class="t">  <span class="key">def</span> <span class="nam">__combineTSDF</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">ts_df_right</span><span class="op">,</span> <span class="nam">combined_ts_col</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t77" class="mis show_mis"><span class="n"><a href="#t77">77</a></span><span class="t">    <span class="nam">combined_df</span> <span class="op">=</span> <span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">df</span>&nbsp;</span><span class="r"></span></p>
    <p id="t78" class="pln"><span class="n"><a href="#t78">78</a></span><span class="t">                   <span class="op">.</span><span class="nam">unionByName</span><span class="op">(</span><span class="nam">ts_df_right</span><span class="op">.</span><span class="nam">df</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t79" class="pln"><span class="n"><a href="#t79">79</a></span><span class="t">                   <span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="nam">combined_ts_col</span><span class="op">,</span><span class="nam">f</span><span class="op">.</span><span class="nam">coalesce</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">,</span> <span class="nam">ts_df_right</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t80" class="pln"><span class="n"><a href="#t80">80</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t81" class="mis show_mis"><span class="n"><a href="#t81">81</a></span><span class="t">    <span class="key">return</span> <span class="nam">TSDF</span><span class="op">(</span><span class="nam">combined_df</span><span class="op">,</span> <span class="nam">combined_ts_col</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t82" class="pln"><span class="n"><a href="#t82">82</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t83" class="run"><span class="n"><a href="#t83">83</a></span><span class="t">  <span class="key">def</span> <span class="nam">__getLastRightRow</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">left_ts_col</span><span class="op">,</span> <span class="nam">right_cols</span><span class="op">,</span> <span class="nam">sequence_col</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t84" class="mis show_mis"><span class="n"><a href="#t84">84</a></span><span class="t">    <span class="key">from</span> <span class="nam">functools</span> <span class="key">import</span> <span class="nam">reduce</span>&nbsp;</span><span class="r"></span></p>
    <p id="t85" class="pln"><span class="n"><a href="#t85">85</a></span><span class="t">    <span class="str">"""Get last right value of each right column (inc. right timestamp) for each self.ts_col value</span>&nbsp;</span><span class="r"></span></p>
    <p id="t86" class="pln"><span class="n"><a href="#t86">86</a></span><span class="t"><span class="str">    </span>&nbsp;</span><span class="r"></span></p>
    <p id="t87" class="pln"><span class="n"><a href="#t87">87</a></span><span class="t"><span class="str">    self.ts_col, which is the combined time-stamp column of both left and right dataframe, is dropped at the end</span>&nbsp;</span><span class="r"></span></p>
    <p id="t88" class="pln"><span class="n"><a href="#t88">88</a></span><span class="t"><span class="str">    since it is no longer used in subsequent methods.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t89" class="pln"><span class="n"><a href="#t89">89</a></span><span class="t"><span class="str">    """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t90" class="mis show_mis"><span class="n"><a href="#t90">90</a></span><span class="t">    <span class="nam">ptntl_sort_keys</span> <span class="op">=</span> <span class="op">[</span><span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">,</span> <span class="nam">sequence_col</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t91" class="mis show_mis"><span class="n"><a href="#t91">91</a></span><span class="t">    <span class="nam">sort_keys</span> <span class="op">=</span> <span class="op">[</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">col_name</span><span class="op">)</span> <span class="key">for</span> <span class="nam">col_name</span> <span class="key">in</span> <span class="nam">ptntl_sort_keys</span> <span class="key">if</span> <span class="nam">col_name</span> <span class="op">!=</span> <span class="str">''</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t92" class="pln"><span class="n"><a href="#t92">92</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t93" class="mis show_mis"><span class="n"><a href="#t93">93</a></span><span class="t">    <span class="nam">window_spec</span> <span class="op">=</span> <span class="nam">Window</span><span class="op">.</span><span class="nam">partitionBy</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">)</span><span class="op">.</span><span class="nam">orderBy</span><span class="op">(</span><span class="nam">sort_keys</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t94" class="mis show_mis"><span class="n"><a href="#t94">94</a></span><span class="t">    <span class="nam">df</span> <span class="op">=</span> <span class="nam">reduce</span><span class="op">(</span><span class="key">lambda</span> <span class="nam">df</span><span class="op">,</span> <span class="nam">idx</span><span class="op">:</span> <span class="nam">df</span><span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="nam">right_cols</span><span class="op">[</span><span class="nam">idx</span><span class="op">]</span><span class="op">,</span> <span class="nam">f</span><span class="op">.</span><span class="nam">last</span><span class="op">(</span><span class="nam">right_cols</span><span class="op">[</span><span class="nam">idx</span><span class="op">]</span><span class="op">,</span> <span class="key">True</span><span class="op">)</span><span class="op">.</span><span class="nam">over</span><span class="op">(</span><span class="nam">window_spec</span><span class="op">)</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t95" class="pln"><span class="n"><a href="#t95">95</a></span><span class="t">                     <span class="nam">range</span><span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">right_cols</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">df</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t96" class="pln"><span class="n"><a href="#t96">96</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t97" class="mis show_mis"><span class="n"><a href="#t97">97</a></span><span class="t">    <span class="nam">df</span> <span class="op">=</span> <span class="op">(</span><span class="nam">df</span><span class="op">.</span><span class="nam">filter</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">left_ts_col</span><span class="op">)</span><span class="op">.</span><span class="nam">isNotNull</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="nam">drop</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t98" class="pln"><span class="n"><a href="#t98">98</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t99" class="mis show_mis"><span class="n"><a href="#t99">99</a></span><span class="t">    <span class="key">return</span> <span class="nam">TSDF</span><span class="op">(</span><span class="nam">df</span><span class="op">,</span> <span class="nam">left_ts_col</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t100" class="pln"><span class="n"><a href="#t100">100</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t101" class="run"><span class="n"><a href="#t101">101</a></span><span class="t">  <span class="key">def</span> <span class="nam">__getTimePartitions</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">tsPartitionVal</span><span class="op">,</span> <span class="nam">fraction</span><span class="op">=</span><span class="num">0.1</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t102" class="pln"><span class="n"><a href="#t102">102</a></span><span class="t">    <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t103" class="pln"><span class="n"><a href="#t103">103</a></span><span class="t"><span class="str">    Create time-partitions for our data-set. We put our time-stamps into brackets of &lt;tsPartitionVal>. Timestamps</span>&nbsp;</span><span class="r"></span></p>
    <p id="t104" class="pln"><span class="n"><a href="#t104">104</a></span><span class="t"><span class="str">    are rounded down to the nearest &lt;tsPartitionVal> seconds.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t105" class="pln"><span class="n"><a href="#t105">105</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t106" class="pln"><span class="n"><a href="#t106">106</a></span><span class="t"><span class="str">    We cast our timestamp column to double instead of using f.unix_timestamp, since it provides more precision.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t107" class="pln"><span class="n"><a href="#t107">107</a></span><span class="t"><span class="str">    </span>&nbsp;</span><span class="r"></span></p>
    <p id="t108" class="pln"><span class="n"><a href="#t108">108</a></span><span class="t"><span class="str">    Additionally, we make these partitions overlapping by adding a remainder df. This way when calculating the</span>&nbsp;</span><span class="r"></span></p>
    <p id="t109" class="pln"><span class="n"><a href="#t109">109</a></span><span class="t"><span class="str">    last right timestamp we will not end up with nulls for the first left timestamp in each partition.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t110" class="pln"><span class="n"><a href="#t110">110</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t111" class="pln"><span class="n"><a href="#t111">111</a></span><span class="t"><span class="str">    TODO: change ts_partition to accomodate for higher precision than seconds.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t112" class="pln"><span class="n"><a href="#t112">112</a></span><span class="t"><span class="str">    """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t113" class="mis show_mis"><span class="n"><a href="#t113">113</a></span><span class="t">    <span class="nam">partition_df</span> <span class="op">=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p id="t114" class="pln"><span class="n"><a href="#t114">114</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">df</span>&nbsp;</span><span class="r"></span></p>
    <p id="t115" class="pln"><span class="n"><a href="#t115">115</a></span><span class="t">        <span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="str">"ts_col_double"</span><span class="op">,</span> <span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">)</span><span class="op">.</span><span class="nam">cast</span><span class="op">(</span><span class="str">"double"</span><span class="op">)</span><span class="op">)</span> <span class="com"># double is preferred over unix_timestamp</span>&nbsp;</span><span class="r"></span></p>
    <p id="t116" class="pln"><span class="n"><a href="#t116">116</a></span><span class="t">        <span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="str">'ts_partition'</span><span class="op">,</span><span class="nam">f</span><span class="op">.</span><span class="nam">lit</span><span class="op">(</span><span class="nam">tsPartitionVal</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="str">"ts_col_double"</span><span class="op">)</span> <span class="op">/</span> <span class="nam">f</span><span class="op">.</span><span class="nam">lit</span><span class="op">(</span><span class="nam">tsPartitionVal</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="nam">cast</span><span class="op">(</span><span class="str">'integer'</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t117" class="pln"><span class="n"><a href="#t117">117</a></span><span class="t">        <span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="str">"partition_remainder"</span><span class="op">,</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="str">"ts_col_double"</span><span class="op">)</span> <span class="op">-</span> <span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="str">"ts_partition"</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="nam">f</span><span class="op">.</span><span class="nam">lit</span><span class="op">(</span><span class="nam">tsPartitionVal</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t118" class="pln"><span class="n"><a href="#t118">118</a></span><span class="t">        <span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="str">"is_original"</span><span class="op">,</span> <span class="nam">f</span><span class="op">.</span><span class="nam">lit</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="nam">cache</span><span class="op">(</span><span class="op">)</span> <span class="com"># cache it because it's used twice.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t119" class="pln"><span class="n"><a href="#t119">119</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t120" class="pln"><span class="n"><a href="#t120">120</a></span><span class="t">    <span class="com"># add [1 - fraction] of previous time partition to the next partition.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t121" class="mis show_mis"><span class="n"><a href="#t121">121</a></span><span class="t">    <span class="nam">remainder_df</span> <span class="op">=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p id="t122" class="pln"><span class="n"><a href="#t122">122</a></span><span class="t">      <span class="nam">partition_df</span><span class="op">.</span><span class="nam">filter</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="str">"partition_remainder"</span><span class="op">)</span> <span class="op">>=</span> <span class="nam">f</span><span class="op">.</span><span class="nam">lit</span><span class="op">(</span><span class="num">1</span> <span class="op">-</span> <span class="nam">fraction</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t123" class="pln"><span class="n"><a href="#t123">123</a></span><span class="t">      <span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="str">"ts_partition"</span><span class="op">,</span> <span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="str">"ts_partition"</span><span class="op">)</span> <span class="op">+</span> <span class="nam">f</span><span class="op">.</span><span class="nam">lit</span><span class="op">(</span><span class="nam">tsPartitionVal</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t124" class="pln"><span class="n"><a href="#t124">124</a></span><span class="t">      <span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="str">"is_original"</span><span class="op">,</span><span class="nam">f</span><span class="op">.</span><span class="nam">lit</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t125" class="pln"><span class="n"><a href="#t125">125</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t126" class="mis show_mis"><span class="n"><a href="#t126">126</a></span><span class="t">    <span class="nam">df</span> <span class="op">=</span> <span class="nam">partition_df</span><span class="op">.</span><span class="nam">union</span><span class="op">(</span><span class="nam">remainder_df</span><span class="op">)</span><span class="op">.</span><span class="nam">drop</span><span class="op">(</span><span class="str">"partition_remainder"</span><span class="op">,</span><span class="str">"ts_col_double"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t127" class="mis show_mis"><span class="n"><a href="#t127">127</a></span><span class="t">    <span class="key">return</span> <span class="nam">TSDF</span><span class="op">(</span><span class="nam">df</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span> <span class="op">+</span> <span class="op">[</span><span class="str">'ts_partition'</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t128" class="pln"><span class="n"><a href="#t128">128</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t129" class="run"><span class="n"><a href="#t129">129</a></span><span class="t">  <span class="key">def</span> <span class="nam">asofJoin</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">right_tsdf</span><span class="op">,</span> <span class="nam">left_prefix</span><span class="op">=</span><span class="key">None</span><span class="op">,</span> <span class="nam">right_prefix</span><span class="op">=</span><span class="str">"right"</span><span class="op">,</span> <span class="nam">tsPartitionVal</span><span class="op">=</span><span class="key">None</span><span class="op">,</span> <span class="nam">fraction</span><span class="op">=</span><span class="num">0.5</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t130" class="pln"><span class="n"><a href="#t130">130</a></span><span class="t">    <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t131" class="pln"><span class="n"><a href="#t131">131</a></span><span class="t"><span class="str">    Performs an as-of join between two time-series. If a tsPartitionVal is specified, it will do this partitioned by</span>&nbsp;</span><span class="r"></span></p>
    <p id="t132" class="pln"><span class="n"><a href="#t132">132</a></span><span class="t"><span class="str">    time brackets, which can help alleviate skew.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t133" class="pln"><span class="n"><a href="#t133">133</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t134" class="pln"><span class="n"><a href="#t134">134</a></span><span class="t"><span class="str">    NOTE: partition cols have to be the same for both Dataframes.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t135" class="pln"><span class="n"><a href="#t135">135</a></span><span class="t"><span class="str">    Parameters</span>&nbsp;</span><span class="r"></span></p>
    <p id="t136" class="pln"><span class="n"><a href="#t136">136</a></span><span class="t"><span class="str">    :param right_tsdf - right-hand data frame containing columns to merge in</span>&nbsp;</span><span class="r"></span></p>
    <p id="t137" class="pln"><span class="n"><a href="#t137">137</a></span><span class="t"><span class="str">    :param left_prefix - optional prefix for base data frame</span>&nbsp;</span><span class="r"></span></p>
    <p id="t138" class="pln"><span class="n"><a href="#t138">138</a></span><span class="t"><span class="str">    :param right_prefix - optional prefix for right-hand data frame</span>&nbsp;</span><span class="r"></span></p>
    <p id="t139" class="pln"><span class="n"><a href="#t139">139</a></span><span class="t"><span class="str">    :param tsPartitionVal - value to break up each partition into time brackets</span>&nbsp;</span><span class="r"></span></p>
    <p id="t140" class="pln"><span class="n"><a href="#t140">140</a></span><span class="t"><span class="str">    :param fraction - overlap fraction</span>&nbsp;</span><span class="r"></span></p>
    <p id="t141" class="pln"><span class="n"><a href="#t141">141</a></span><span class="t"><span class="str">    """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t142" class="pln"><span class="n"><a href="#t142">142</a></span><span class="t">    <span class="com"># Check whether partition columns have same name in both dataframes</span>&nbsp;</span><span class="r"></span></p>
    <p id="t143" class="mis show_mis"><span class="n"><a href="#t143">143</a></span><span class="t">    <span class="nam">self</span><span class="op">.</span><span class="nam">__checkPartitionCols</span><span class="op">(</span><span class="nam">right_tsdf</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t144" class="pln"><span class="n"><a href="#t144">144</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t145" class="pln"><span class="n"><a href="#t145">145</a></span><span class="t">    <span class="com"># prefix non-partition columns, to avoid duplicated columns.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t146" class="mis show_mis"><span class="n"><a href="#t146">146</a></span><span class="t">    <span class="nam">left_df</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">df</span>&nbsp;</span><span class="r"></span></p>
    <p id="t147" class="mis show_mis"><span class="n"><a href="#t147">147</a></span><span class="t">    <span class="nam">right_df</span> <span class="op">=</span> <span class="nam">right_tsdf</span><span class="op">.</span><span class="nam">df</span>&nbsp;</span><span class="r"></span></p>
    <p id="t148" class="pln"><span class="n"><a href="#t148">148</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t149" class="mis show_mis"><span class="n"><a href="#t149">149</a></span><span class="t">    <span class="nam">orig_left_col_diff</span> <span class="op">=</span> <span class="nam">list</span><span class="op">(</span><span class="nam">set</span><span class="op">(</span><span class="nam">left_df</span><span class="op">.</span><span class="nam">columns</span><span class="op">)</span><span class="op">.</span><span class="nam">difference</span><span class="op">(</span><span class="nam">set</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t150" class="mis show_mis"><span class="n"><a href="#t150">150</a></span><span class="t">    <span class="nam">orig_right_col_diff</span> <span class="op">=</span> <span class="nam">list</span><span class="op">(</span><span class="nam">set</span><span class="op">(</span><span class="nam">right_df</span><span class="op">.</span><span class="nam">columns</span><span class="op">)</span><span class="op">.</span><span class="nam">difference</span><span class="op">(</span><span class="nam">set</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t151" class="pln"><span class="n"><a href="#t151">151</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t152" class="mis show_mis"><span class="n"><a href="#t152">152</a></span><span class="t">    <span class="nam">left_tsdf</span> <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">__addPrefixToColumns</span><span class="op">(</span><span class="op">[</span><span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">]</span> <span class="op">+</span> <span class="nam">orig_left_col_diff</span><span class="op">,</span> <span class="nam">left_prefix</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t153" class="pln"><span class="n"><a href="#t153">153</a></span><span class="t">                 <span class="key">if</span> <span class="nam">left_prefix</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span> <span class="key">else</span> <span class="nam">self</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t154" class="mis show_mis"><span class="n"><a href="#t154">154</a></span><span class="t">    <span class="nam">right_tsdf</span> <span class="op">=</span> <span class="nam">right_tsdf</span><span class="op">.</span><span class="nam">__addPrefixToColumns</span><span class="op">(</span><span class="op">[</span><span class="nam">right_tsdf</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">]</span> <span class="op">+</span> <span class="nam">orig_right_col_diff</span><span class="op">,</span> <span class="nam">right_prefix</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t155" class="pln"><span class="n"><a href="#t155">155</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t156" class="mis show_mis"><span class="n"><a href="#t156">156</a></span><span class="t">    <span class="nam">left_nonpartition_cols</span> <span class="op">=</span> <span class="nam">list</span><span class="op">(</span><span class="nam">set</span><span class="op">(</span><span class="nam">left_tsdf</span><span class="op">.</span><span class="nam">df</span><span class="op">.</span><span class="nam">columns</span><span class="op">)</span><span class="op">.</span><span class="nam">difference</span><span class="op">(</span><span class="nam">set</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t157" class="mis show_mis"><span class="n"><a href="#t157">157</a></span><span class="t">    <span class="nam">right_nonpartition_cols</span> <span class="op">=</span> <span class="nam">list</span><span class="op">(</span><span class="nam">set</span><span class="op">(</span><span class="nam">right_tsdf</span><span class="op">.</span><span class="nam">df</span><span class="op">.</span><span class="nam">columns</span><span class="op">)</span><span class="op">.</span><span class="nam">difference</span><span class="op">(</span><span class="nam">set</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t158" class="pln"><span class="n"><a href="#t158">158</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t159" class="pln"><span class="n"><a href="#t159">159</a></span><span class="t">    <span class="com"># For both dataframes get all non-partition columns (including ts_col)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t160" class="mis show_mis"><span class="n"><a href="#t160">160</a></span><span class="t">    <span class="nam">left_columns</span> <span class="op">=</span> <span class="op">[</span><span class="nam">left_tsdf</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">]</span> <span class="op">+</span> <span class="nam">left_nonpartition_cols</span>&nbsp;</span><span class="r"></span></p>
    <p id="t161" class="mis show_mis"><span class="n"><a href="#t161">161</a></span><span class="t">    <span class="nam">right_columns</span> <span class="op">=</span> <span class="op">[</span><span class="nam">right_tsdf</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">]</span> <span class="op">+</span> <span class="nam">right_nonpartition_cols</span>&nbsp;</span><span class="r"></span></p>
    <p id="t162" class="pln"><span class="n"><a href="#t162">162</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t163" class="pln"><span class="n"><a href="#t163">163</a></span><span class="t">    <span class="com"># Union both dataframes, and create a combined TS column</span>&nbsp;</span><span class="r"></span></p>
    <p id="t164" class="mis show_mis"><span class="n"><a href="#t164">164</a></span><span class="t">    <span class="nam">combined_ts_col</span> <span class="op">=</span> <span class="str">"combined_ts"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t165" class="mis show_mis"><span class="n"><a href="#t165">165</a></span><span class="t">    <span class="nam">combined_df</span> <span class="op">=</span> <span class="op">(</span><span class="nam">left_tsdf</span>&nbsp;</span><span class="r"></span></p>
    <p id="t166" class="pln"><span class="n"><a href="#t166">166</a></span><span class="t">                   <span class="op">.</span><span class="nam">__addColumnsFromOtherDF</span><span class="op">(</span><span class="nam">right_columns</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t167" class="pln"><span class="n"><a href="#t167">167</a></span><span class="t">                   <span class="op">.</span><span class="nam">__combineTSDF</span><span class="op">(</span><span class="nam">right_tsdf</span><span class="op">.</span><span class="nam">__addColumnsFromOtherDF</span><span class="op">(</span><span class="nam">left_columns</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t168" class="pln"><span class="n"><a href="#t168">168</a></span><span class="t">                                  <span class="nam">combined_ts_col</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t169" class="pln"><span class="n"><a href="#t169">169</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t170" class="pln"><span class="n"><a href="#t170">170</a></span><span class="t">    <span class="com"># perform asof join.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t171" class="mis show_mis"><span class="n"><a href="#t171">171</a></span><span class="t">    <span class="key">if</span> <span class="nam">tsPartitionVal</span> <span class="key">is</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t172" class="mis show_mis"><span class="n"><a href="#t172">172</a></span><span class="t">        <span class="nam">asofDF</span> <span class="op">=</span> <span class="nam">combined_df</span><span class="op">.</span><span class="nam">__getLastRightRow</span><span class="op">(</span><span class="nam">left_tsdf</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">,</span> <span class="nam">right_columns</span><span class="op">,</span> <span class="nam">right_tsdf</span><span class="op">.</span><span class="nam">sequence_col</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t173" class="pln"><span class="n"><a href="#t173">173</a></span><span class="t">    <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t174" class="mis show_mis"><span class="n"><a href="#t174">174</a></span><span class="t">        <span class="nam">tsPartitionDF</span> <span class="op">=</span> <span class="nam">combined_df</span><span class="op">.</span><span class="nam">__getTimePartitions</span><span class="op">(</span><span class="nam">tsPartitionVal</span><span class="op">,</span> <span class="nam">fraction</span><span class="op">=</span><span class="nam">fraction</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t175" class="mis show_mis"><span class="n"><a href="#t175">175</a></span><span class="t">        <span class="nam">asofDF</span> <span class="op">=</span> <span class="nam">tsPartitionDF</span><span class="op">.</span><span class="nam">__getLastRightRow</span><span class="op">(</span><span class="nam">left_tsdf</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">,</span> <span class="nam">right_columns</span><span class="op">,</span> <span class="nam">right_tsdf</span><span class="op">.</span><span class="nam">sequence_col</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t176" class="pln"><span class="n"><a href="#t176">176</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t177" class="pln"><span class="n"><a href="#t177">177</a></span><span class="t">        <span class="com"># Get rid of overlapped data and the extra columns generated from timePartitions</span>&nbsp;</span><span class="r"></span></p>
    <p id="t178" class="mis show_mis"><span class="n"><a href="#t178">178</a></span><span class="t">        <span class="nam">df</span> <span class="op">=</span> <span class="nam">asofDF</span><span class="op">.</span><span class="nam">df</span><span class="op">.</span><span class="nam">filter</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="str">"is_original"</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">)</span><span class="op">.</span><span class="nam">drop</span><span class="op">(</span><span class="str">"ts_partition"</span><span class="op">,</span><span class="str">"is_original"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t179" class="pln"><span class="n"><a href="#t179">179</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t180" class="mis show_mis"><span class="n"><a href="#t180">180</a></span><span class="t">        <span class="nam">asofDF</span> <span class="op">=</span> <span class="nam">TSDF</span><span class="op">(</span><span class="nam">df</span><span class="op">,</span> <span class="nam">asofDF</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">,</span> <span class="nam">combined_df</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t181" class="pln"><span class="n"><a href="#t181">181</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t182" class="mis show_mis"><span class="n"><a href="#t182">182</a></span><span class="t">    <span class="key">return</span> <span class="nam">asofDF</span>&nbsp;</span><span class="r"></span></p>
    <p id="t183" class="pln"><span class="n"><a href="#t183">183</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t184" class="pln"><span class="n"><a href="#t184">184</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t185" class="run"><span class="n"><a href="#t185">185</a></span><span class="t">  <span class="key">def</span> <span class="nam">__baseWindow</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t186" class="pln"><span class="n"><a href="#t186">186</a></span><span class="t">    <span class="com"># add all sort keys - time is first, unique sequence number breaks the tie</span>&nbsp;</span><span class="r"></span></p>
    <p id="t187" class="pln"><span class="n"><a href="#t187">187</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t188" class="mis show_mis"><span class="n"><a href="#t188">188</a></span><span class="t">    <span class="nam">ptntl_sort_keys</span> <span class="op">=</span> <span class="op">[</span><span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">sequence_col</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t189" class="mis show_mis"><span class="n"><a href="#t189">189</a></span><span class="t">    <span class="nam">sort_keys</span> <span class="op">=</span> <span class="op">[</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">col_name</span><span class="op">)</span><span class="op">.</span><span class="nam">cast</span><span class="op">(</span><span class="str">"long"</span><span class="op">)</span> <span class="key">for</span> <span class="nam">col_name</span> <span class="key">in</span> <span class="nam">ptntl_sort_keys</span> <span class="key">if</span> <span class="nam">col_name</span> <span class="op">!=</span> <span class="str">''</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t190" class="pln"><span class="n"><a href="#t190">190</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t191" class="mis show_mis"><span class="n"><a href="#t191">191</a></span><span class="t">    <span class="nam">w</span> <span class="op">=</span> <span class="nam">Window</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">orderBy</span><span class="op">(</span><span class="nam">sort_keys</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t192" class="mis show_mis"><span class="n"><a href="#t192">192</a></span><span class="t">    <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t193" class="mis show_mis"><span class="n"><a href="#t193">193</a></span><span class="t">      <span class="nam">w</span> <span class="op">=</span> <span class="nam">w</span><span class="op">.</span><span class="nam">partitionBy</span><span class="op">(</span><span class="op">[</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">elem</span><span class="op">)</span> <span class="key">for</span> <span class="nam">elem</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t194" class="mis show_mis"><span class="n"><a href="#t194">194</a></span><span class="t">    <span class="key">return</span> <span class="nam">w</span>&nbsp;</span><span class="r"></span></p>
    <p id="t195" class="pln"><span class="n"><a href="#t195">195</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t196" class="pln"><span class="n"><a href="#t196">196</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t197" class="run"><span class="n"><a href="#t197">197</a></span><span class="t">  <span class="key">def</span> <span class="nam">__rangeBetweenWindow</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">range_from</span><span class="op">,</span> <span class="nam">range_to</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t198" class="mis show_mis"><span class="n"><a href="#t198">198</a></span><span class="t">    <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">__baseWindow</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">rangeBetween</span><span class="op">(</span><span class="nam">range_from</span><span class="op">,</span> <span class="nam">range_to</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t199" class="pln"><span class="n"><a href="#t199">199</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t200" class="pln"><span class="n"><a href="#t200">200</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t201" class="run"><span class="n"><a href="#t201">201</a></span><span class="t">  <span class="key">def</span> <span class="nam">__rowsBetweenWindow</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">rows_from</span><span class="op">,</span> <span class="nam">rows_to</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t202" class="mis show_mis"><span class="n"><a href="#t202">202</a></span><span class="t">    <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">__baseWindow</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">rowsBetween</span><span class="op">(</span><span class="nam">rows_from</span><span class="op">,</span> <span class="nam">rows_to</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t203" class="pln"><span class="n"><a href="#t203">203</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t204" class="pln"><span class="n"><a href="#t204">204</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t205" class="run"><span class="n"><a href="#t205">205</a></span><span class="t">  <span class="key">def</span> <span class="nam">withPartitionCols</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">partitionCols</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t206" class="pln"><span class="n"><a href="#t206">206</a></span><span class="t">    <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t207" class="pln"><span class="n"><a href="#t207">207</a></span><span class="t"><span class="str">    Sets certain columns of the TSDF as partition columns. Partition columns are those that differentiate distinct timeseries</span>&nbsp;</span><span class="r"></span></p>
    <p id="t208" class="pln"><span class="n"><a href="#t208">208</a></span><span class="t"><span class="str">    from each other.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t209" class="pln"><span class="n"><a href="#t209">209</a></span><span class="t"><span class="str">    :param partitionCols: a list of columns used to partition distinct timeseries</span>&nbsp;</span><span class="r"></span></p>
    <p id="t210" class="pln"><span class="n"><a href="#t210">210</a></span><span class="t"><span class="str">    :return: a TSDF object with the given partition columns</span>&nbsp;</span><span class="r"></span></p>
    <p id="t211" class="pln"><span class="n"><a href="#t211">211</a></span><span class="t"><span class="str">    """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t212" class="mis show_mis"><span class="n"><a href="#t212">212</a></span><span class="t">    <span class="key">return</span> <span class="nam">TSDF</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">df</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">,</span> <span class="nam">partitionCols</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t213" class="pln"><span class="n"><a href="#t213">213</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t214" class="run"><span class="n"><a href="#t214">214</a></span><span class="t">  <span class="key">def</span> <span class="nam">vwap</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">frequency</span><span class="op">=</span><span class="str">'m'</span><span class="op">,</span><span class="nam">volume_col</span> <span class="op">=</span> <span class="str">"volume"</span><span class="op">,</span> <span class="nam">price_col</span> <span class="op">=</span> <span class="str">"price"</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t215" class="pln"><span class="n"><a href="#t215">215</a></span><span class="t">        <span class="com"># set pre_vwap as self or enrich with the frequency</span>&nbsp;</span><span class="r"></span></p>
    <p id="t216" class="mis show_mis"><span class="n"><a href="#t216">216</a></span><span class="t">        <span class="nam">pre_vwap</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">df</span>&nbsp;</span><span class="r"></span></p>
    <p id="t217" class="mis show_mis"><span class="n"><a href="#t217">217</a></span><span class="t">        <span class="nam">print</span><span class="op">(</span><span class="str">'input schema: '</span><span class="op">,</span> <span class="nam">pre_vwap</span><span class="op">.</span><span class="nam">printSchema</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t218" class="mis show_mis"><span class="n"><a href="#t218">218</a></span><span class="t">        <span class="key">if</span> <span class="nam">frequency</span> <span class="op">==</span> <span class="str">'m'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t219" class="mis show_mis"><span class="n"><a href="#t219">219</a></span><span class="t">            <span class="nam">pre_vwap</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">df</span><span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="str">"time_group"</span><span class="op">,</span> <span class="nam">f</span><span class="op">.</span><span class="nam">concat</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">lpad</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">hour</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="num">2</span><span class="op">,</span> <span class="str">'0'</span><span class="op">)</span><span class="op">,</span> <span class="nam">f</span><span class="op">.</span><span class="nam">lit</span><span class="op">(</span><span class="str">':'</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t220" class="pln"><span class="n"><a href="#t220">220</a></span><span class="t">                                                               <span class="nam">f</span><span class="op">.</span><span class="nam">lpad</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">minute</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="num">2</span><span class="op">,</span> <span class="str">'0'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t221" class="mis show_mis"><span class="n"><a href="#t221">221</a></span><span class="t">        <span class="key">elif</span> <span class="nam">frequency</span> <span class="op">==</span> <span class="str">'H'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t222" class="mis show_mis"><span class="n"><a href="#t222">222</a></span><span class="t">            <span class="nam">pre_vwap</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">df</span><span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="str">"time_group"</span><span class="op">,</span> <span class="nam">f</span><span class="op">.</span><span class="nam">concat</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">lpad</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">hour</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="num">2</span><span class="op">,</span> <span class="str">'0'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t223" class="mis show_mis"><span class="n"><a href="#t223">223</a></span><span class="t">        <span class="key">elif</span> <span class="nam">frequency</span> <span class="op">==</span> <span class="str">'D'</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t224" class="mis show_mis"><span class="n"><a href="#t224">224</a></span><span class="t">            <span class="nam">pre_vwap</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">df</span><span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="str">"time_group"</span><span class="op">,</span> <span class="nam">f</span><span class="op">.</span><span class="nam">concat</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">lpad</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">day</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="num">2</span><span class="op">,</span> <span class="str">'0'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t225" class="pln"><span class="n"><a href="#t225">225</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t226" class="mis show_mis"><span class="n"><a href="#t226">226</a></span><span class="t">        <span class="nam">group_cols</span> <span class="op">=</span> <span class="op">[</span><span class="str">'time_group'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t227" class="mis show_mis"><span class="n"><a href="#t227">227</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t228" class="mis show_mis"><span class="n"><a href="#t228">228</a></span><span class="t">          <span class="nam">group_cols</span><span class="op">.</span><span class="nam">extend</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t229" class="mis show_mis"><span class="n"><a href="#t229">229</a></span><span class="t">        <span class="nam">vwapped</span> <span class="op">=</span> <span class="op">(</span> <span class="nam">pre_vwap</span><span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="str">"dllr_value"</span><span class="op">,</span> <span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">price_col</span><span class="op">)</span> <span class="op">*</span> <span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">volume_col</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t230" class="pln"><span class="n"><a href="#t230">230</a></span><span class="t">                            <span class="op">.</span><span class="nam">groupby</span><span class="op">(</span><span class="nam">group_cols</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t231" class="pln"><span class="n"><a href="#t231">231</a></span><span class="t">                            <span class="op">.</span><span class="nam">agg</span><span class="op">(</span> <span class="nam">sum</span><span class="op">(</span><span class="str">'dllr_value'</span><span class="op">)</span><span class="op">.</span><span class="nam">alias</span><span class="op">(</span><span class="str">"dllr_value"</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t232" class="pln"><span class="n"><a href="#t232">232</a></span><span class="t">                                  <span class="nam">sum</span><span class="op">(</span><span class="nam">volume_col</span><span class="op">)</span><span class="op">.</span><span class="nam">alias</span><span class="op">(</span><span class="nam">volume_col</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t233" class="pln"><span class="n"><a href="#t233">233</a></span><span class="t">                                  <span class="nam">max</span><span class="op">(</span><span class="nam">price_col</span><span class="op">)</span><span class="op">.</span><span class="nam">alias</span><span class="op">(</span><span class="str">"_"</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="op">[</span><span class="str">"max"</span><span class="op">,</span><span class="nam">price_col</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t234" class="pln"><span class="n"><a href="#t234">234</a></span><span class="t">                            <span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="str">"vwap"</span><span class="op">,</span> <span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="str">"dllr_value"</span><span class="op">)</span> <span class="op">/</span> <span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">volume_col</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t235" class="pln"><span class="n"><a href="#t235">235</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t236" class="mis show_mis"><span class="n"><a href="#t236">236</a></span><span class="t">        <span class="key">return</span> <span class="nam">TSDF</span><span class="op">(</span> <span class="nam">vwapped</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span> <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t237" class="pln"><span class="n"><a href="#t237">237</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t238" class="run"><span class="n"><a href="#t238">238</a></span><span class="t">  <span class="key">def</span> <span class="nam">EMA</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span><span class="nam">colName</span><span class="op">,</span><span class="nam">window</span><span class="op">=</span><span class="num">30</span><span class="op">,</span><span class="nam">exp_factor</span> <span class="op">=</span> <span class="num">0.2</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t239" class="pln"><span class="n"><a href="#t239">239</a></span><span class="t">    <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t240" class="pln"><span class="n"><a href="#t240">240</a></span><span class="t"><span class="str">    Constructs an approximate EMA in the fashion of:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t241" class="pln"><span class="n"><a href="#t241">241</a></span><span class="t"><span class="str">    EMA = e * lag(col,0) + e * (1 - e) * lag(col, 1) + e * (1 - e)^2 * lag(col, 2) etc, up until window</span>&nbsp;</span><span class="r"></span></p>
    <p id="t242" class="pln"><span class="n"><a href="#t242">242</a></span><span class="t"><span class="str">    TODO: replace case when statement with coalesce</span>&nbsp;</span><span class="r"></span></p>
    <p id="t243" class="pln"><span class="n"><a href="#t243">243</a></span><span class="t"><span class="str">    TODO: add in time partitions functionality (what is the overlap fraction?)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t244" class="pln"><span class="n"><a href="#t244">244</a></span><span class="t"><span class="str">    """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t245" class="pln"><span class="n"><a href="#t245">245</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t246" class="mis show_mis"><span class="n"><a href="#t246">246</a></span><span class="t">    <span class="nam">emaColName</span> <span class="op">=</span> <span class="str">"_"</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="op">[</span><span class="str">"EMA"</span><span class="op">,</span><span class="nam">colName</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t247" class="mis show_mis"><span class="n"><a href="#t247">247</a></span><span class="t">    <span class="nam">df</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">df</span><span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="nam">emaColName</span><span class="op">,</span><span class="nam">f</span><span class="op">.</span><span class="nam">lit</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="nam">orderBy</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t248" class="mis show_mis"><span class="n"><a href="#t248">248</a></span><span class="t">    <span class="nam">w</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">__baseWindow</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t249" class="pln"><span class="n"><a href="#t249">249</a></span><span class="t">    <span class="com"># Generate all the lag columns:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t250" class="mis show_mis"><span class="n"><a href="#t250">250</a></span><span class="t">    <span class="key">for</span> <span class="nam">i</span> <span class="key">in</span> <span class="nam">range</span><span class="op">(</span><span class="nam">window</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t251" class="mis show_mis"><span class="n"><a href="#t251">251</a></span><span class="t">      <span class="nam">lagColName</span> <span class="op">=</span> <span class="str">"_"</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="op">[</span><span class="str">"lag"</span><span class="op">,</span><span class="nam">colName</span><span class="op">,</span><span class="nam">str</span><span class="op">(</span><span class="nam">i</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t252" class="mis show_mis"><span class="n"><a href="#t252">252</a></span><span class="t">      <span class="nam">weight</span> <span class="op">=</span> <span class="nam">exp_factor</span> <span class="op">*</span> <span class="op">(</span><span class="num">1</span> <span class="op">-</span> <span class="nam">exp_factor</span><span class="op">)</span><span class="op">**</span><span class="nam">i</span>&nbsp;</span><span class="r"></span></p>
    <p id="t253" class="mis show_mis"><span class="n"><a href="#t253">253</a></span><span class="t">      <span class="nam">df</span> <span class="op">=</span> <span class="nam">df</span><span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="nam">lagColName</span><span class="op">,</span> <span class="nam">weight</span> <span class="op">*</span> <span class="nam">f</span><span class="op">.</span><span class="nam">lag</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">colName</span><span class="op">)</span><span class="op">,</span><span class="nam">i</span><span class="op">)</span><span class="op">.</span><span class="nam">over</span><span class="op">(</span><span class="nam">w</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t254" class="mis show_mis"><span class="n"><a href="#t254">254</a></span><span class="t">      <span class="nam">df</span> <span class="op">=</span> <span class="nam">df</span><span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="nam">emaColName</span><span class="op">,</span> <span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">emaColName</span><span class="op">)</span> <span class="op">+</span> <span class="nam">f</span><span class="op">.</span><span class="nam">when</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p id="t255" class="pln"><span class="n"><a href="#t255">255</a></span><span class="t">          <span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">lagColName</span><span class="op">)</span><span class="op">.</span><span class="nam">isNull</span><span class="op">(</span><span class="op">)</span><span class="op">,</span><span class="nam">f</span><span class="op">.</span><span class="nam">lit</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="nam">otherwise</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">lagColName</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="nam">drop</span><span class="op">(</span><span class="nam">lagColName</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t256" class="pln"><span class="n"><a href="#t256">256</a></span><span class="t">      <span class="com"># Nulls are currently removed</span>&nbsp;</span><span class="r"></span></p>
    <p id="t257" class="pln"><span class="n"><a href="#t257">257</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t258" class="mis show_mis"><span class="n"><a href="#t258">258</a></span><span class="t">    <span class="key">return</span> <span class="nam">TSDF</span><span class="op">(</span><span class="nam">df</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t259" class="pln"><span class="n"><a href="#t259">259</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t260" class="run"><span class="n"><a href="#t260">260</a></span><span class="t">  <span class="key">def</span> <span class="nam">withLookbackFeatures</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t261" class="pln"><span class="n"><a href="#t261">261</a></span><span class="t">                           <span class="nam">featureCols</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t262" class="pln"><span class="n"><a href="#t262">262</a></span><span class="t">                           <span class="nam">lookbackWindowSize</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t263" class="pln"><span class="n"><a href="#t263">263</a></span><span class="t">                           <span class="nam">exactSize</span><span class="op">=</span><span class="key">True</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t264" class="pln"><span class="n"><a href="#t264">264</a></span><span class="t">                           <span class="nam">featureColName</span><span class="op">=</span><span class="str">"features"</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t265" class="pln"><span class="n"><a href="#t265">265</a></span><span class="t">      <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t266" class="pln"><span class="n"><a href="#t266">266</a></span><span class="t"><span class="str">      Creates a 2-D feature tensor suitable for training an ML model to predict current values from the history of</span>&nbsp;</span><span class="r"></span></p>
    <p id="t267" class="pln"><span class="n"><a href="#t267">267</a></span><span class="t"><span class="str">      some set of features. This function creates a new column containing, for each observation, a 2-D array of the values</span>&nbsp;</span><span class="r"></span></p>
    <p id="t268" class="pln"><span class="n"><a href="#t268">268</a></span><span class="t"><span class="str">      of some number of other columns over a trailing "lookback" window from the previous observation up to some maximum</span>&nbsp;</span><span class="r"></span></p>
    <p id="t269" class="pln"><span class="n"><a href="#t269">269</a></span><span class="t"><span class="str">      number of past observations.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t270" class="pln"><span class="n"><a href="#t270">270</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t271" class="pln"><span class="n"><a href="#t271">271</a></span><span class="t"><span class="str">      :param featureCols: the names of one or more feature columns to be aggregated into the feature column</span>&nbsp;</span><span class="r"></span></p>
    <p id="t272" class="pln"><span class="n"><a href="#t272">272</a></span><span class="t"><span class="str">      :param lookbackWindowSize: The size of lookback window (in terms of past observations). Must be an integer >= 1</span>&nbsp;</span><span class="r"></span></p>
    <p id="t273" class="pln"><span class="n"><a href="#t273">273</a></span><span class="t"><span class="str">      :param exactSize: If True (the default), then the resulting DataFrame will only include observations where the</span>&nbsp;</span><span class="r"></span></p>
    <p id="t274" class="pln"><span class="n"><a href="#t274">274</a></span><span class="t"><span class="str">        generated feature column contains arrays of length lookbackWindowSize. This implies that it will truncate</span>&nbsp;</span><span class="r"></span></p>
    <p id="t275" class="pln"><span class="n"><a href="#t275">275</a></span><span class="t"><span class="str">        observations that occurred less than lookbackWindowSize from the start of the timeseries. If False, no truncation</span>&nbsp;</span><span class="r"></span></p>
    <p id="t276" class="pln"><span class="n"><a href="#t276">276</a></span><span class="t"><span class="str">        occurs, and the column may contain arrays less than lookbackWindowSize in length.</span>&nbsp;</span><span class="r"></span></p>
    <p id="t277" class="pln"><span class="n"><a href="#t277">277</a></span><span class="t"><span class="str">      :param featureColName: The name of the feature column to be generated. Defaults to "features"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t278" class="pln"><span class="n"><a href="#t278">278</a></span><span class="t"><span class="str">      :return: a DataFrame with a feature column named featureColName containing the lookback feature tensor</span>&nbsp;</span><span class="r"></span></p>
    <p id="t279" class="pln"><span class="n"><a href="#t279">279</a></span><span class="t"><span class="str">      """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t280" class="pln"><span class="n"><a href="#t280">280</a></span><span class="t">      <span class="com"># first, join all featureCols into a single array column</span>&nbsp;</span><span class="r"></span></p>
    <p id="t281" class="mis show_mis"><span class="n"><a href="#t281">281</a></span><span class="t">      <span class="nam">tempArrayColName</span> <span class="op">=</span> <span class="str">"__TempArrayCol"</span>&nbsp;</span><span class="r"></span></p>
    <p id="t282" class="mis show_mis"><span class="n"><a href="#t282">282</a></span><span class="t">      <span class="nam">feat_array_tsdf</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">df</span><span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="nam">tempArrayColName</span><span class="op">,</span> <span class="nam">f</span><span class="op">.</span><span class="nam">array</span><span class="op">(</span><span class="nam">featureCols</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t283" class="pln"><span class="n"><a href="#t283">283</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t284" class="pln"><span class="n"><a href="#t284">284</a></span><span class="t">      <span class="com"># construct a lookback array</span>&nbsp;</span><span class="r"></span></p>
    <p id="t285" class="mis show_mis"><span class="n"><a href="#t285">285</a></span><span class="t">      <span class="nam">lookback_win</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">__rowsBetweenWindow</span><span class="op">(</span><span class="op">-</span><span class="nam">lookbackWindowSize</span><span class="op">,</span> <span class="op">-</span><span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t286" class="mis show_mis"><span class="n"><a href="#t286">286</a></span><span class="t">      <span class="nam">lookback_tsdf</span> <span class="op">=</span> <span class="op">(</span><span class="nam">feat_array_tsdf</span><span class="op">.</span><span class="nam">withColumn</span><span class="op">(</span><span class="nam">featureColName</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p id="t287" class="pln"><span class="n"><a href="#t287">287</a></span><span class="t">                                                  <span class="nam">f</span><span class="op">.</span><span class="nam">collect_list</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">tempArrayColName</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="nam">over</span><span class="op">(</span><span class="nam">lookback_win</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t288" class="pln"><span class="n"><a href="#t288">288</a></span><span class="t">                                      <span class="op">.</span><span class="nam">drop</span><span class="op">(</span><span class="nam">tempArrayColName</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t289" class="pln"><span class="n"><a href="#t289">289</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t290" class="pln"><span class="n"><a href="#t290">290</a></span><span class="t">      <span class="com"># make sure only windows of exact size are allowed</span>&nbsp;</span><span class="r"></span></p>
    <p id="t291" class="mis show_mis"><span class="n"><a href="#t291">291</a></span><span class="t">      <span class="key">if</span> <span class="nam">exactSize</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t292" class="mis show_mis"><span class="n"><a href="#t292">292</a></span><span class="t">          <span class="key">return</span> <span class="nam">lookback_tsdf</span><span class="op">.</span><span class="nam">where</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">size</span><span class="op">(</span><span class="nam">featureColName</span><span class="op">)</span> <span class="op">==</span> <span class="nam">lookbackWindowSize</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t293" class="pln"><span class="n"><a href="#t293">293</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t294" class="mis show_mis"><span class="n"><a href="#t294">294</a></span><span class="t">      <span class="key">return</span> <span class="nam">TSDF</span><span class="op">(</span> <span class="nam">lookback_tsdf</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span> <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t295" class="pln"><span class="n"><a href="#t295">295</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t296" class="run"><span class="n"><a href="#t296">296</a></span><span class="t">  <span class="key">def</span> <span class="nam">withRangeStats</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">type</span><span class="op">=</span><span class="str">'range'</span><span class="op">,</span> <span class="nam">colsToSummarize</span><span class="op">=</span><span class="op">[</span><span class="op">]</span><span class="op">,</span> <span class="nam">rangeBackWindowSecs</span><span class="op">=</span><span class="num">1000</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t297" class="pln"><span class="n"><a href="#t297">297</a></span><span class="t">          <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t298" class="pln"><span class="n"><a href="#t298">298</a></span><span class="t"><span class="str">          Create a wider set of stats based on all numeric columns by default</span>&nbsp;</span><span class="r"></span></p>
    <p id="t299" class="pln"><span class="n"><a href="#t299">299</a></span><span class="t"><span class="str">          Users can choose which columns they want to summarize also. These stats are:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t300" class="pln"><span class="n"><a href="#t300">300</a></span><span class="t"><span class="str">          mean/count/min/max/sum/std deviation/zscore</span>&nbsp;</span><span class="r"></span></p>
    <p id="t301" class="pln"><span class="n"><a href="#t301">301</a></span><span class="t"><span class="str">          :param type - this is created in case we want to extend these stats to lookback over a fixed number of rows instead of ranging over column values</span>&nbsp;</span><span class="r"></span></p>
    <p id="t302" class="pln"><span class="n"><a href="#t302">302</a></span><span class="t"><span class="str">          :param colsToSummarize - list of user-supplied columns to compute stats for. All numeric columns are used if no list is provided</span>&nbsp;</span><span class="r"></span></p>
    <p id="t303" class="pln"><span class="n"><a href="#t303">303</a></span><span class="t"><span class="str">          :param rangeBackWindowSecs - lookback this many seconds in time to summarize all stats. Note this will look back from the floor of the base event timestamp (as opposed to the exact time since we cast to long)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t304" class="pln"><span class="n"><a href="#t304">304</a></span><span class="t"><span class="str">          Assumptions:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t305" class="pln"><span class="n"><a href="#t305">305</a></span><span class="t"><span class="str">               1. The features are summarized over a rolling window that ranges back</span>&nbsp;</span><span class="r"></span></p>
    <p id="t306" class="pln"><span class="n"><a href="#t306">306</a></span><span class="t"><span class="str">               2. The range back window can be specified by the user</span>&nbsp;</span><span class="r"></span></p>
    <p id="t307" class="pln"><span class="n"><a href="#t307">307</a></span><span class="t"><span class="str">               3. Sequence numbers are not yet supported for the sort</span>&nbsp;</span><span class="r"></span></p>
    <p id="t308" class="pln"><span class="n"><a href="#t308">308</a></span><span class="t"><span class="str">               4. There is a cast to long from timestamp so microseconds or more likely breaks down - this could be more easily handled with a string timestamp or sorting the timestamp itself. If using a 'rows preceding' window, this wouldn't be a problem</span>&nbsp;</span><span class="r"></span></p>
    <p id="t309" class="pln"><span class="n"><a href="#t309">309</a></span><span class="t"><span class="str">           """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t310" class="pln"><span class="n"><a href="#t310">310</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t311" class="pln"><span class="n"><a href="#t311">311</a></span><span class="t">          <span class="com"># identify columns to summarize if not provided</span>&nbsp;</span><span class="r"></span></p>
    <p id="t312" class="pln"><span class="n"><a href="#t312">312</a></span><span class="t">          <span class="com"># these should include all numeric columns that</span>&nbsp;</span><span class="r"></span></p>
    <p id="t313" class="pln"><span class="n"><a href="#t313">313</a></span><span class="t">          <span class="com"># are not the timestamp column and not any of the partition columns</span>&nbsp;</span><span class="r"></span></p>
    <p id="t314" class="mis show_mis"><span class="n"><a href="#t314">314</a></span><span class="t">          <span class="key">if</span> <span class="key">not</span> <span class="nam">colsToSummarize</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t315" class="pln"><span class="n"><a href="#t315">315</a></span><span class="t">            <span class="com"># columns we should never summarize</span>&nbsp;</span><span class="r"></span></p>
    <p id="t316" class="mis show_mis"><span class="n"><a href="#t316">316</a></span><span class="t">            <span class="nam">prohibited_cols</span> <span class="op">=</span> <span class="op">[</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">.</span><span class="nam">lower</span><span class="op">(</span><span class="op">)</span> <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t317" class="mis show_mis"><span class="n"><a href="#t317">317</a></span><span class="t">            <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t318" class="mis show_mis"><span class="n"><a href="#t318">318</a></span><span class="t">              <span class="nam">prohibited_cols</span><span class="op">.</span><span class="nam">extend</span><span class="op">(</span><span class="op">[</span> <span class="nam">pc</span><span class="op">.</span><span class="nam">lower</span><span class="op">(</span><span class="op">)</span> <span class="key">for</span> <span class="nam">pc</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t319" class="pln"><span class="n"><a href="#t319">319</a></span><span class="t">            <span class="com"># types that can be summarized</span>&nbsp;</span><span class="r"></span></p>
    <p id="t320" class="mis show_mis"><span class="n"><a href="#t320">320</a></span><span class="t">            <span class="nam">summarizable_types</span> <span class="op">=</span> <span class="op">[</span><span class="str">'int'</span><span class="op">,</span> <span class="str">'bigint'</span><span class="op">,</span> <span class="str">'float'</span><span class="op">,</span> <span class="str">'double'</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t321" class="pln"><span class="n"><a href="#t321">321</a></span><span class="t">            <span class="com"># filter columns to find summarizable columns</span>&nbsp;</span><span class="r"></span></p>
    <p id="t322" class="mis show_mis"><span class="n"><a href="#t322">322</a></span><span class="t">            <span class="nam">colsToSummarize</span> <span class="op">=</span> <span class="op">[</span><span class="nam">datatype</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">for</span> <span class="nam">datatype</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">df</span><span class="op">.</span><span class="nam">dtypes</span> <span class="key">if</span>&nbsp;</span><span class="r"></span></p>
    <p id="t323" class="pln"><span class="n"><a href="#t323">323</a></span><span class="t">                                <span class="op">(</span><span class="op">(</span><span class="nam">datatype</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">in</span> <span class="nam">summarizable_types</span><span class="op">)</span> <span class="key">and</span>&nbsp;</span><span class="r"></span></p>
    <p id="t324" class="pln"><span class="n"><a href="#t324">324</a></span><span class="t">                                 <span class="op">(</span><span class="nam">datatype</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">lower</span><span class="op">(</span><span class="op">)</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">prohibited_cols</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t325" class="pln"><span class="n"><a href="#t325">325</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t326" class="pln"><span class="n"><a href="#t326">326</a></span><span class="t">          <span class="com"># build window</span>&nbsp;</span><span class="r"></span></p>
    <p id="t327" class="mis show_mis"><span class="n"><a href="#t327">327</a></span><span class="t">          <span class="nam">w</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">__rangeBetweenWindow</span><span class="op">(</span><span class="op">-</span><span class="num">1</span> <span class="op">*</span> <span class="nam">rangeBackWindowSecs</span><span class="op">,</span> <span class="num">0</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t328" class="pln"><span class="n"><a href="#t328">328</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t329" class="pln"><span class="n"><a href="#t329">329</a></span><span class="t">          <span class="com"># compute column summaries</span>&nbsp;</span><span class="r"></span></p>
    <p id="t330" class="mis show_mis"><span class="n"><a href="#t330">330</a></span><span class="t">          <span class="nam">selectedCols</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">df</span><span class="op">.</span><span class="nam">columns</span>&nbsp;</span><span class="r"></span></p>
    <p id="t331" class="mis show_mis"><span class="n"><a href="#t331">331</a></span><span class="t">          <span class="nam">derivedCols</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p id="t332" class="mis show_mis"><span class="n"><a href="#t332">332</a></span><span class="t">          <span class="key">for</span> <span class="nam">metric</span> <span class="key">in</span> <span class="nam">colsToSummarize</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t333" class="mis show_mis"><span class="n"><a href="#t333">333</a></span><span class="t">              <span class="nam">selectedCols</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">mean</span><span class="op">(</span><span class="nam">metric</span><span class="op">)</span><span class="op">.</span><span class="nam">over</span><span class="op">(</span><span class="nam">w</span><span class="op">)</span><span class="op">.</span><span class="nam">alias</span><span class="op">(</span><span class="str">'mean_'</span> <span class="op">+</span> <span class="nam">metric</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t334" class="mis show_mis"><span class="n"><a href="#t334">334</a></span><span class="t">              <span class="nam">selectedCols</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">count</span><span class="op">(</span><span class="nam">metric</span><span class="op">)</span><span class="op">.</span><span class="nam">over</span><span class="op">(</span><span class="nam">w</span><span class="op">)</span><span class="op">.</span><span class="nam">alias</span><span class="op">(</span><span class="str">'count_'</span> <span class="op">+</span> <span class="nam">metric</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t335" class="mis show_mis"><span class="n"><a href="#t335">335</a></span><span class="t">              <span class="nam">selectedCols</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">min</span><span class="op">(</span><span class="nam">metric</span><span class="op">)</span><span class="op">.</span><span class="nam">over</span><span class="op">(</span><span class="nam">w</span><span class="op">)</span><span class="op">.</span><span class="nam">alias</span><span class="op">(</span><span class="str">'min_'</span> <span class="op">+</span> <span class="nam">metric</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t336" class="mis show_mis"><span class="n"><a href="#t336">336</a></span><span class="t">              <span class="nam">selectedCols</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">max</span><span class="op">(</span><span class="nam">metric</span><span class="op">)</span><span class="op">.</span><span class="nam">over</span><span class="op">(</span><span class="nam">w</span><span class="op">)</span><span class="op">.</span><span class="nam">alias</span><span class="op">(</span><span class="str">'max_'</span> <span class="op">+</span> <span class="nam">metric</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t337" class="mis show_mis"><span class="n"><a href="#t337">337</a></span><span class="t">              <span class="nam">selectedCols</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">sum</span><span class="op">(</span><span class="nam">metric</span><span class="op">)</span><span class="op">.</span><span class="nam">over</span><span class="op">(</span><span class="nam">w</span><span class="op">)</span><span class="op">.</span><span class="nam">alias</span><span class="op">(</span><span class="str">'sum_'</span> <span class="op">+</span> <span class="nam">metric</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t338" class="mis show_mis"><span class="n"><a href="#t338">338</a></span><span class="t">              <span class="nam">selectedCols</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">stddev</span><span class="op">(</span><span class="nam">metric</span><span class="op">)</span><span class="op">.</span><span class="nam">over</span><span class="op">(</span><span class="nam">w</span><span class="op">)</span><span class="op">.</span><span class="nam">alias</span><span class="op">(</span><span class="str">'stddev_'</span> <span class="op">+</span> <span class="nam">metric</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t339" class="mis show_mis"><span class="n"><a href="#t339">339</a></span><span class="t">              <span class="nam">derivedCols</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p id="t340" class="pln"><span class="n"><a href="#t340">340</a></span><span class="t">                      <span class="op">(</span><span class="op">(</span><span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="nam">metric</span><span class="op">)</span> <span class="op">-</span> <span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="str">'mean_'</span> <span class="op">+</span> <span class="nam">metric</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="nam">f</span><span class="op">.</span><span class="nam">col</span><span class="op">(</span><span class="str">'stddev_'</span> <span class="op">+</span> <span class="nam">metric</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="nam">alias</span><span class="op">(</span><span class="str">"zscore_"</span> <span class="op">+</span> <span class="nam">metric</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t341" class="mis show_mis"><span class="n"><a href="#t341">341</a></span><span class="t">          <span class="nam">selected_df</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">df</span><span class="op">.</span><span class="nam">select</span><span class="op">(</span><span class="op">*</span><span class="nam">selectedCols</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t342" class="pln"><span class="n"><a href="#t342">342</a></span><span class="t">          <span class="com">#print(derivedCols)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t343" class="mis show_mis"><span class="n"><a href="#t343">343</a></span><span class="t">          <span class="nam">summary_df</span> <span class="op">=</span> <span class="nam">selected_df</span><span class="op">.</span><span class="nam">select</span><span class="op">(</span><span class="op">*</span><span class="nam">selected_df</span><span class="op">.</span><span class="nam">columns</span><span class="op">,</span> <span class="op">*</span><span class="nam">derivedCols</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t344" class="pln"><span class="n"><a href="#t344">344</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t345" class="mis show_mis"><span class="n"><a href="#t345">345</a></span><span class="t">          <span class="key">return</span> <span class="nam">TSDF</span><span class="op">(</span><span class="nam">summary_df</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">ts_col</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">partitionCols</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t346" class="pln"><span class="n"><a href="#t346">346</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t347" class="run"><span class="n"><a href="#t347">347</a></span><span class="t">  <span class="key">def</span> <span class="nam">write</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">tabName</span><span class="op">,</span> <span class="nam">optimizationCols</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t348" class="mis show_mis"><span class="n"><a href="#t348">348</a></span><span class="t">    <span class="nam">tio</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">tabName</span><span class="op">,</span> <span class="nam">optimizationCols</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t349" class="pln"><span class="n"><a href="#t349">349</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p id="t350" class="run"><span class="n"><a href="#t350">350</a></span><span class="t">  <span class="key">def</span> <span class="nam">resample</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">freq</span><span class="op">,</span> <span class="nam">func</span><span class="op">=</span><span class="key">None</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p id="t351" class="pln"><span class="n"><a href="#t351">351</a></span><span class="t">    <span class="str">"""</span>&nbsp;</span><span class="r"></span></p>
    <p id="t352" class="pln"><span class="n"><a href="#t352">352</a></span><span class="t"><span class="str">    function to upsample based on frequency and aggregate function similar to pandas</span>&nbsp;</span><span class="r"></span></p>
    <p id="t353" class="pln"><span class="n"><a href="#t353">353</a></span><span class="t"><span class="str">    :param freq: frequency for upsample - valid inputs are "hr", "min", "sec" corresponding to hour, minute, or second</span>&nbsp;</span><span class="r"></span></p>
    <p id="t354" class="pln"><span class="n"><a href="#t354">354</a></span><span class="t"><span class="str">    :param func: function used to aggregate input</span>&nbsp;</span><span class="r"></span></p>
    <p id="t355" class="pln"><span class="n"><a href="#t355">355</a></span><span class="t"><span class="str">    :return: TSDF object with sample data using aggregate function</span>&nbsp;</span><span class="r"></span></p>
    <p id="t356" class="pln"><span class="n"><a href="#t356">356</a></span><span class="t"><span class="str">    """</span>&nbsp;</span><span class="r"></span></p>
    <p id="t357" class="mis show_mis"><span class="n"><a href="#t357">357</a></span><span class="t">    <span class="nam">rs</span><span class="op">.</span><span class="nam">validateFuncExists</span><span class="op">(</span><span class="nam">func</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t358" class="mis show_mis"><span class="n"><a href="#t358">358</a></span><span class="t">    <span class="nam">enriched_tsdf</span> <span class="op">=</span> <span class="nam">rs</span><span class="op">.</span><span class="nam">aggregate</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">freq</span><span class="op">,</span> <span class="nam">func</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p id="t359" class="mis show_mis"><span class="n"><a href="#t359">359</a></span><span class="t">    <span class="key">return</span><span class="op">(</span><span class="nam">enriched_tsdf</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
</div>
<div id="footer">
    <div class="content">
        <p>
            <a class="nav" href="index.html">&#xab; index</a> &nbsp; &nbsp; <a class="nav" href="https://coverage.readthedocs.io">coverage.py v5.3</a>,
            created at 2020-11-11 17:01 -0500
        </p>
    </div>
</div>
</body>
</html>
